<!doctype html>
<html lang="tl">
<head>
    <meta charset="utf-8">
    <title>Admin Dashboard - Barangay e-Document</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fontawesome/6.0.0/css/all.min.css">
</head>
<body>
    <header>
        <div class="logo">Barangay e-Doc</div>
        <nav>
            <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a>
            <div class="language-selector">
                <select id="languageSelect" onchange="changeLanguage(this.value)">
                    <option value="en">English</option>
                    <option value="tl" selected>Filipino</option>
                </select>
            </div>
        </nav>
    </header>
    <main class="container">
        <section class="dashboard-content">
            {% if user_info %}
            <!-- USER INFO VIEW -->
            <h1><i class="fas fa-user"></i> Impormasyon ng Gumagamit</h1>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <p><strong>Pangalan:</strong> {{ user_info['first_name'] }}</p>
                <p><strong>Apelyido:</strong> {{ user_info['last_name'] }}</p>
                <p><strong>Buong Pangalan:</strong> {{ user_info['fullname'] }}</p>
                <p><strong>Kontak:</strong> {{ user_info['contact'] or 'Walang ibinigay' }}</p>
                <p><strong>Email:</strong> {{ user_info['email'] }}</p>
                <p><strong>Petsa ng Kapanganakan:</strong> {{ user_info['birthdate'] or 'Walang ibinigay' }}</p>
                <p><strong>Katayuang Sibil:</strong> {{ user_info['civil_status'] or 'Walang ibinigay' }}</p>
                <p><strong>Address:</strong> {{ user_info['address'] or 'Walang ibinigay' }}</p>
                <p><strong>Pangalan ng Ama:</strong> {{ user_info['fathers_name'] or 'Walang ibinigay' }}</p>
                <p><strong>Pangalan ng Ina:</strong> {{ user_info['mothers_name'] or 'Walang ibinigay' }}</p>
                <p><strong>Pook ng Kapanganakan:</strong> {{ user_info['birthplace'] or 'Walang ibinigay' }}</p>
                <p><strong>Miyembro Mula:</strong> {{ user_info['created_at'] or 'Wala' }}</p>
            </div>
            <a href="{{ url_for('admin_dashboard') }}" class="btn">Bumalik sa Dashboard</a>
            {% else %}
            <!-- ADMIN DASHBOARD -->
            <h1 style="text-align: center;"><i class="fas fa-cogs"></i> Admin Dashboard</h1>
            <p style="text-align: center;">Kabuuang Gumagamit: {{ total_users }} | Kabuuang Kahilingan: {{ total_requests }}</p>
            
            <h2 style="text-align: center;"><i class="fas fa-chart-bar"></i> Estadistika ng mga Kahilingan</h2>
            <div class="stats">
                <div class="stat-card">
                    <h3>Kabuuang Kahilingan</h3>
                    <p>{{ total_requests }}</p>
                </div>
                <div class="stat-card">
                    <h3>Nakabinbin</h3>
                    <p>{{ requests | selectattr('status', 'equalto', 'Pending') | list | length }}</p>
                </div>
                <div class="stat-card">
                    <h3>Pinoproseso</h3>
                    <p>{{ requests | selectattr('status', 'equalto', 'Processing') | list | length }}</p>
                </div>
                <div class="stat-card">
                    <h3>Handa nang Kunin</h3>
                    <p>{{ requests | selectattr('status', 'equalto', 'Ready to be Claim') | list | length }}</p>
                </div>
                <div class="stat-card">
                    <h3>Tapos na</h3>
                    <p>{{ requests | selectattr('status', 'equalto', 'Completed') | list | length }}</p>
                </div>
            </div>

            <h2 style="text-align: center;"><i class="fas fa-users"></i> Mga Rehistradong Gumagamit</h2>
            <div style="text-align: center; margin-bottom: 20px;">
                <button onclick="toggleUsers()" class="btn">Tingnan ang Lahat ng Gumagamit</button>
            </div>
            <div id="users-section" style="display: none;">
                <form method="GET" style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px;">
                        <input type="text" name="search" placeholder="Maghanap ayon sa pangalan o apelyido" value="{{ search_query or '' }}" style="padding: 10px; width: 300px;">
                        <button type="submit" class="btn">Hanapin</button>
                        {% if search_query %}
                        <a href="{{ url_for('admin_dashboard') }}" class="btn">I-clear ang Paghahanap</a>
                        {% endif %}
                    </div>
                </form>

                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Pangalan</th>
                            <th>Apelyido</th>
                            <th>Buong Pangalan</th>
                            <th>Email</th>
                            <th>Aksyon</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ user['first_name'] }}</td>
                            <td>{{ user['last_name'] }}</td>
                            <td>{{ user['fullname'] }}</td>
                            <td>{{ user['email'] }}</td>
                            <td>
                                <!-- View User Info -->
                                <form method="POST" style="display:inline;">
                                    <input type="hidden" name="user_id" value="{{ user['id'] }}">
                                    <button type="submit" name="view_user" class="btn" style="padding: 6px 12px; font-size: 12px;">Tingnan</button>
                                </form>

                                <!-- Delete User -->
                                <form action="{{ url_for('delete_user', user_id=user['id']) }}" method="POST" style="display:inline;">
                                    <button type="submit" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px; background:#dc3545; color:white;"
                                            onclick="return confirm('Sigurado ka bang gusto mong burahin ang user na ito?')">
                                        Delete
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if not users %}
                <p style="text-align: center; color: #666; font-size: 16px; margin-top: 20px;">Walang Natagpuang Gumagamit</p>
                {% endif %}
            </div>

            <h2 style="text-align: center;"><i class="fas fa-file-alt"></i> Pamahalaan ang mga Kahilingan</h2>
            <form method="GET" style="margin-bottom: 20px;">
                <select name="status" onchange="this.form.submit()">
                    <option value="">Lahat ng Katayuan</option>
                    <option value="Pending" {% if status_filter == 'Pending' %}selected{% endif %}>Nakabinbin</option>
                    <option value="Processing" {% if status_filter == 'Processing' %}selected{% endif %}>Pinoproseso</option>
                    <option value="Verifying" {% if status_filter == 'Verifying' %}selected{% endif %}>Sini-siyasat</option>
                    <option value="Ready to be Claim" {% if status_filter == 'Ready to be Claim' %}selected{% endif %}>Handa nang Kunin</option>
                </select>
            </form>
            {% if requests|length > 5 %}
            <div style="text-align: center; margin-bottom: 20px;">
                <button id="expand-btn" onclick="toggleRequests()" class="btn">Ipakita Lahat</button>
            </div>
            {% endif %}

            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Buong Pangalan</th>
                        <th>Email</th>
                        <th>Dokumento</th>
                        <th>Layunin</th>
                        <th>Katayuan</th>
                        <th>Petsa ng Pagsusumite</th>
                        <th>Aksyon</th>
                    </tr>
                </thead>
                <tbody>
                        {% for req in requests %}
                        <tr class="{% if loop.index > 5 %}extra-row{% endif %}" {% if loop.index > 5 %}style="display: none;"{% endif %}>
                            <td>{{ req['id'] }}</td>
                            <td>{{ req['fullname'] }}</td>
                            <td>{{ req['email'] }}</td>
                            <td>{{ req['document_type'] }}</td>
                            <td>
                                <button class="btn" style="padding: 6px 10px; font-size: 11px;" onclick="showPurpose('{{ req['id'] }}', `{{ req['purpose'] | replace('`', '\\`') }}`)">Tingnan</button>
                            </td>

                            <td>
                                {% if req['status'] == 'Pending' %}
                                    <span style="background:#ffc107; color:#000; padding:6px 10px; border-radius:6px; font-weight:bold;">Nakabinbin</span>
                                {% elif req['status'] == 'Processing' %}
                                    <span style="background:#17a2b8; color:#fff; padding:6px 10px; border-radius:6px; font-weight:bold;">Pinoproseso</span>
                                {% elif req['status'] == 'Verifying' %}
                                    <span style="background:#6f42c1; color:#fff; padding:6px 10px; border-radius:6px; font-weight:bold;">Sini-siyasat</span>
                                {% elif req['status'] == 'Ready to be Claim' %}
                                    <span style="background:#007bff; color:#fff; padding:6px 10px; border-radius:6px; font-weight:bold;">Handa nang Kunin</span>
                                {% elif req['status'] == 'Completed' %}
                                    <span style="background:#28a745; color:#fff; padding:6px 10px; border-radius:6px; font-weight:bold;">Tapos na</span>
                                {% elif req['status'] == 'Rejected' %}
                                    <span style="background:#dc3545; color:#fff; padding:6px 10px; border-radius:6px; font-weight:bold;">Tinanggihan</span>
                                {% else %}
                                    <span style="background:#6c757d; color:#fff; padding:6px 10px; border-radius:6px; font-weight:bold;">{{ req['status'] }}</span>
                                {% endif %}
                            
                            </td>
                            <td>{{ req['date_submitted'] }}</td>
                            <td>
                                {% if req['status'] == 'Pending' %}
                                <a href="{{ url_for('update_status', req_id=req['id'], status='Processing') }}" class="btn" style="padding: 6px 8px; font-size: 11px;">Tanggapin</a>
                                <a href="{{ url_for('update_status', req_id=req['id'], status='Rejected') }}" class="btn" style="padding: 6px 8px; font-size: 11px;">Tanggihan</a>
                                {% elif req['status'] == 'Processing' %}
                                <a href="{{ url_for('update_status', req_id=req['id'], status='Verifying') }}" class="btn" style="padding: 6px 8px; font-size: 11px;">Siyasatin</a>
                                <a href="{{ url_for('update_status', req_id=req['id'], status='Rejected') }}" class="btn" style="padding: 6px 8px; font-size: 11px;">Tanggihan</a>
                                {% elif req['status'] == 'Verifying' %}
                                <a href="{{ url_for('update_status', req_id=req['id'], status='Ready to be Claim') }}" class="btn" style="padding: 6px 8px; font-size: 11px;">Markahan na Handa</a>
                                <a href="{{ url_for('update_status', req_id=req['id'], status='Rejected') }}" class="btn" style="padding: 6px 8px; font-size: 11px;">Tanggihan</a>
                                {% elif req['status'] == 'Ready to be Claim' %}
                                <a href="{{ url_for('update_status', req_id=req['id'], status='Completed') }}" class="btn" style="padding: 6px 8px; font-size: 11px;">Tapos na</a>
                                {% elif req['status'] in ['Completed', 'Rejected'] %}
                                <a href="{{ url_for('delete_request', req_id=req['id']) }}" class="btn" style="padding: 6px 8px; font-size: 11px; background: #dc3545; color: #fff;">Tanggalin</a>
                                {% else %}
                                <span style="color: #999;">Walang Aksyon</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>

            </table>
            {% endif %}
            
            <div style="text-align: center; margin-top: 20px;">
                <a href="{{ url_for('all_records') }}" class="btn">Tingnan ang Lahat ng Rekord</a>
            </div>
        </section>
    </main>
    <footer>
        <p>&copy; 2025 Barangay e-Document System. Lahat ng Karapatan ay Nakalaan.</p>
    </footer>

    <script>
        function changeLanguage(lang) {
            window.location.href = "{{ url_for('set_language', lang='') }}" + lang;
        }
        document.getElementById('languageSelect').value = '{{ session.get("lang", "tl") }}';

        function toggleUsers() {
            var section = document.getElementById('users-section');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        function toggleRequests() {
            var extraRows = document.querySelectorAll('.extra-row');
            var btn = document.getElementById('expand-btn');
            var isExpanded = btn.textContent === 'I-collapse';
            extraRows.forEach(row => row.style.display = isExpanded ? 'none' : 'table-row');
            btn.textContent = isExpanded ? 'Ipakita Lahat' : 'I-collapse';
        }
    </script>
    <!-- Modal for Viewing Purpose -->
<div id="purposeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000;">
    <div style="background:#fff; padding:20px; border-radius:8px; width:400px; max-width:90%; position:relative;">
        <h3><i class="fas fa-comment"></i> Layunin ng Kahilingan</h3>
        <p id="purposeText" style="margin-top:10px; color:#333; white-space:pre-line;"></p>
        <button onclick="closePurpose()" class="btn" style="margin-top:15px;">Isara</button>
    </div>
</div>

<script>
function showPurpose(id, text) {
    document.getElementById('purposeText').innerText = text || 'Walang ibinigay na layunin.';
    document.getElementById('purposeModal').style.display = 'flex';
}

function closePurpose() {
    document.getElementById('purposeModal').style.display = 'none';
}
</script>
</body>
</html>
