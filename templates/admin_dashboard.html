<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Admin Dashboard - Barangay e-Document</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fontawesome/6.0.0/css/all.min.css">
</head>
<body>
    <header>
        <div class="logo">Barangay e-Doc</div>
        <nav>
            <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a>
            <div class="language-selector">
                <select id="languageSelect" onchange="changeLanguage(this.value)">
                    <option value="en" selected>English</option>
                    <option value="tl">Filipino</option>
                </select>
            </div>
        </nav>
    </header>
    <main class="container">
        <section class="dashboard-content">
            {% if user_info %}
            <!-- USER INFO VIEW -->
            <h1><i class="fas fa-user"></i> User Information</h1>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <p><strong>First Name:</strong> {{ user_info['first_name'] }}</p>
                <p><strong>Last Name:</strong> {{ user_info['last_name'] }}</p>
                <p><strong>Full Name:</strong> {{ user_info['fullname'] }}</p>
                <p><strong>Contact:</strong> {{ user_info['contact'] or 'Not provided' }}</p>
                <p><strong>Email:</strong> {{ user_info['email'] }}</p>
                <p><strong>Birthdate:</strong> {{ user_info['birthdate'] or 'Not provided' }}</p>
                <p><strong>Civil Status:</strong> {{ user_info['civil_status'] or 'Not provided' }}</p>
                <p><strong>Address:</strong> {{ user_info['address'] or 'Not provided' }}</p>
                <p><strong>Father's Name:</strong> {{ user_info['fathers_name'] or 'Not provided' }}</p>
                <p><strong>Mother's Name:</strong> {{ user_info['mothers_name'] or 'Not provided' }}</p>
                <p><strong>Birthplace:</strong> {{ user_info['birthplace'] or 'Not provided' }}</p>
                <p><strong>Member Since:</strong> {{ user_info['created_at'] or 'N/A' }}</p>
            </div>
            <a href="{{ url_for('admin_dashboard') }}" class="btn">Back to Dashboard</a>
            {% else %}
            <!-- ADMIN DASHBOARD -->
            <h1 style="text-align: center;"><i class="fas fa-cogs"></i> Admin Dashboard</h1>
            <p style="text-align: center;">Total Users: {{ total_users }} | Total Requests: {{ total_requests }}</p>
            
            <h2 style="text-align: center;"><i class="fas fa-chart-bar"></i> Request Statistics</h2>
            <div class="stats">
                <div class="stat-card">
                    <h3>Total Requests</h3>
                    <p>{{ total_requests }}</p>
                </div>
                <div class="stat-card">
                    <h3>Pending</h3>
                    <p>{{ requests | selectattr('status', 'equalto', 'Pending') | list | length }}</p>
                </div>
                <div class="stat-card">
                    <h3>Processing</h3>
                    <p>{{ requests | selectattr('status', 'equalto', 'Processing') | list | length }}</p>
                </div>
                <div class="stat-card">
                    <h3>Ready to Claim</h3>
                    <p>{{ requests | selectattr('status', 'equalto', 'Ready to be Claim') | list | length }}</p>
                </div>
                <div class="stat-card">
                    <h3>Completed</h3>
                    <p>{{ requests | selectattr('status', 'equalto', 'Completed') | list | length }}</p>
                </div>
            </div>

            <h2 style="text-align: center;"><i class="fas fa-users"></i> Registered Users</h2>
            <div style="text-align: center; margin-bottom: 20px;">
                <button onclick="toggleUsers()" class="btn">See all Users</button>
            </div>
            <div id="users-section" style="display: none;">
                <form method="GET" style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px;">
                        <input type="text" name="search" placeholder="Search by first or last name" value="{{ search_query or '' }}" style="padding: 10px; width: 300px;">
                        <button type="submit" class="btn">Search</button>
                        {% if search_query %}
                        <a href="{{ url_for('admin_dashboard') }}" class="btn">Clear Search</a>
                        {% endif %}
                    </div>
                </form>

                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ user['first_name'] }}</td>
                            <td>{{ user['last_name'] }}</td>
                            <td>{{ user['fullname'] }}</td>
                            <td>{{ user['email'] }}</td>
                            <td>
                                <!-- View User Info -->
                                <form method="POST" style="display:inline;">
                                    <input type="hidden" name="user_id" value="{{ user['id'] }}">
                                    <button type="submit" name="view_user" class="btn" style="padding: 6px 12px; font-size: 12px;">View Info</button>
                                </form>

                                <!-- Delete User -->
                                <form action="{{ url_for('delete_user', user_id=user['id']) }}" method="POST" style="display:inline;">
                                    <button type="submit" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px; background:#dc3545; color:white;"
                                            onclick="return confirm('Are you sure you want to delete this user?')">
                                        Delete
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if not users %}
                <p style="text-align: center; color: #666; font-size: 16px; margin-top: 20px;">No Users Found</p>
                {% endif %}
            </div>

            <h2 style="text-align: center;"><i class="fas fa-file-alt"></i> Manage Requests</h2>
            <form method="GET" style="margin-bottom: 20px;">
                <select name="status" onchange="this.form.submit()">
                    <option value="">All Status</option>
                    <option value="Pending" {% if status_filter == 'Pending' %}selected{% endif %}>Pending</option>
                    <option value="Processing" {% if status_filter == 'Processing' %}selected{% endif %}>Processing</option>
                    <option value="Verifying" {% if status_filter == 'Verifying' %}selected{% endif %}>Verifying</option>
                    <option value="Ready to be Claim" {% if status_filter == 'Ready to be Claim' %}selected{% endif %}>Ready to Claim</option>
                </select>
            </form>
            {% if requests|length > 5 %}
            <div style="text-align: center; margin-bottom: 20px;">
                <button id="expand-btn" onclick="toggleRequests()" class="btn">Click to expand</button>
            </div>
            {% endif %}

            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Document</th>
                        <th>Purpose</th>
                        <th>Status</th>
                        <th>Date Submitted</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                        {% for req in requests %}
                        <tr class="{% if loop.index > 5 %}extra-row{% endif %}" {% if loop.index > 5 %}style="display: none;"{% endif %}>
                            <td>{{ req['id'] }}</td>
                            <td>{{ req['fullname'] }}</td>
                            <td>{{ req['email'] }}</td>
                            <td>{{ req['document_type'] }}</td>
                            <td>
                                <button class="btn" style="padding: 6px 10px; font-size: 11px;" onclick="showPurpose('{{ req['id'] }}', `{{ req['purpose'] | replace('`', '\\`') }}`)">View</button>
                            </td>

                            <td>
                                {% if req['status'] == 'Pending' %}
                                    <span style="background:#ffc107; color:#000; padding:6px 10px; border-radius:6px; font-weight:bold;">Pending</span>
                                {% elif req['status'] == 'Processing' %}
                                    <span style="background:#17a2b8; color:#fff; padding:6px 10px; border-radius:6px; font-weight:bold;">Processing</span>
                                {% elif req['status'] == 'Verifying' %}
                                    <span style="background:#6f42c1; color:#fff; padding:6px 10px; border-radius:6px; font-weight:bold;">Verifying</span>
                                {% elif req['status'] == 'Ready to be Claim' %}
                                    <span style="background:#007bff; color:#fff; padding:6px 10px; border-radius:6px; font-weight:bold;">Ready to be Claim</span>
                                {% elif req['status'] == 'Completed' %}
                                    <span style="background:#28a745; color:#fff; padding:6px 10px; border-radius:6px; font-weight:bold;">Completed</span>
                                {% elif req['status'] == 'Rejected' %}
                                    <span style="background:#dc3545; color:#fff; padding:6px 10px; border-radius:6px; font-weight:bold;">Rejected</span>
                                {% else %}
                                    <span style="background:#6c757d; color:#fff; padding:6px 10px; border-radius:6px; font-weight:bold;">{{ req['status'] }}</span>
                                {% endif %}
                            
                            </td>
                            <td>{{ req['date_submitted'] }}</td>
                            <td>
                                {% if req['status'] == 'Pending' %}
                                <a href="{{ url_for('update_status', req_id=req['id'], status='Processing') }}" class="btn" style="padding: 6px 8px; font-size: 11px;">Accept</a>
                                <a href="{{ url_for('update_status', req_id=req['id'], status='Rejected') }}" class="btn" style="padding: 6px 8px; font-size: 11px;">Reject</a>
                                {% elif req['status'] == 'Processing' %}
                                <a href="{{ url_for('update_status', req_id=req['id'], status='Verifying') }}" class="btn" style="padding: 6px 8px; font-size: 11px;">Verify</a>
                                <a href="{{ url_for('update_status', req_id=req['id'], status='Rejected') }}" class="btn" style="padding: 6px 8px; font-size: 11px;">Reject</a>
                                {% elif req['status'] == 'Verifying' %}
                                <a href="{{ url_for('update_status', req_id=req['id'], status='Ready to be Claim') }}" class="btn" style="padding: 6px 8px; font-size: 11px;">Mark Ready</a>
                                <a href="{{ url_for('update_status', req_id=req['id'], status='Rejected') }}" class="btn" style="padding: 6px 8px; font-size: 11px;">Reject</a>
                                {% elif req['status'] == 'Ready to be Claim' %}
                                <a href="{{ url_for('update_status', req_id=req['id'], status='Completed') }}" class="btn" style="padding: 6px 8px; font-size: 11px;">Completed</a>
                                {% elif req['status'] in ['Completed', 'Rejected'] %}
                                <a href="{{ url_for('delete_request', req_id=req['id']) }}" class="btn" style="padding: 6px 8px; font-size: 11px; background: #dc3545; color: #fff;">Remove</a>
                                {% else %}
                                <span style="color: #999;">No actions</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>

            </table>
            {% endif %}
            
            <div style="text-align: center; margin-top: 20px;">
                <a href="{{ url_for('all_records') }}" class="btn">View All Records</a>
            </div>
        </section>
    </main>
    <footer>
        <p>&copy; 2025 Barangay e-Document System. All rights reserved.</p>
    </footer>

    <script>
        function changeLanguage(lang) {
            window.location.href = "{{ url_for('set_language', lang='') }}" + lang;
        }
        document.getElementById('languageSelect').value = '{{ session.get("lang", "en") }}';

        function toggleUsers() {
            var section = document.getElementById('users-section');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        function toggleRequests() {
            var extraRows = document.querySelectorAll('.extra-row');
            var btn = document.getElementById('expand-btn');
            var isExpanded = btn.textContent === 'Click to collapse';
            extraRows.forEach(row => row.style.display = isExpanded ? 'none' : 'table-row');
            btn.textContent = isExpanded ? 'Click to expand' : 'Click to collapse';
        }
    </script>
    <!-- Modal for Viewing Purpose -->
<div id="purposeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000;">
    <div style="background:#fff; padding:20px; border-radius:8px; width:400px; max-width:90%; position:relative;">
        <h3><i class="fas fa-comment"></i> Request Purpose</h3>
        <p id="purposeText" style="margin-top:10px; color:#333; white-space:pre-line;"></p>
        <button onclick="closePurpose()" class="btn" style="margin-top:15px;">Close</button>
    </div>
</div>

<script>
function showPurpose(id, text) {
    document.getElementById('purposeText').innerText = text || 'No purpose provided.';
    document.getElementById('purposeModal').style.display = 'flex';
}

function closePurpose() {
    document.getElementById('purposeModal').style.display = 'none';
}
</script>
</body>
</html>
